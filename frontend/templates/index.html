<!DOCTYPE html>
<html>
<head>
    <title>Buzz Wire Game 🎮</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        let playerName = '';
        let canStartGame = false;

        document.addEventListener("DOMContentLoaded", function () {
            loadLeaderboard();
            
            // Listen for key presses
            document.addEventListener("keydown", function (event) {
                if (event.key === "s" || event.key === "S") {
                    if (canStartGame) {
                        fetch("/start", { method: "POST" })
                            .then(res => res.json())
                            .then(data => {
                                console.log(data);
                                if (data.status === "error") {
                                    showMessage(data.message, "error");
                                }
                            });
                    } else {
                        showMessage("Please enter your name first!", "error");
                    }
                }
                if (event.key === "r" || event.key === "R") {
                    fetch("/restart", { method: "POST" })
                        .then(res => res.json())
                        .then(data => {
                            console.log(data);
                            loadLeaderboard();
                        });
                }
            });

            // Name input functionality
            const nameInput = document.getElementById('nameInput');
            const setNameBtn = document.getElementById('setNameBtn');
            const playerDisplay = document.getElementById('playerDisplay');

            setNameBtn.addEventListener('click', setPlayerName);
            nameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setPlayerName();
                }
            });

            // Load leaderboard every 5 seconds
            setInterval(loadLeaderboard, 5000);
        });

        function setPlayerName() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            
            if (name === '') {
                showMessage("Please enter a valid name!", "error");
                return;
            }

            fetch("/set_name", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ name: name })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    playerName = data.name;
                    canStartGame = true;
                    document.getElementById('playerDisplay').innerHTML = 
                        `<span class="player-name">Player: ${playerName}</span>
                         <button onclick="clearName()" class="clear-btn">Change Player</button>`;
                    nameInput.style.display = 'none';
                    document.getElementById('setNameBtn').style.display = 'none';
                    showMessage(`Welcome ${playerName}! Press 'S' to start!`, "success");
                } else {
                    showMessage(data.message, "error");
                }
            })
            .catch(err => {
                console.error("Error:", err);
                showMessage("Error setting name", "error");
            });
        }

        function clearName() {
            playerName = '';
            canStartGame = false;
            document.getElementById('nameInput').style.display = 'block';
            document.getElementById('setNameBtn').style.display = 'block';
            document.getElementById('nameInput').value = '';
            document.getElementById('playerDisplay').innerHTML = '';
            showMessage("Enter your name to play", "info");
        }

        function loadLeaderboard() {
            fetch("/get_leaderboard")
                .then(res => res.json())
                .then(data => {
                    updateLeaderboard(data.leaderboard);
                })
                .catch(err => {
                    console.error("Error loading leaderboard:", err);
                });
        }

        function updateLeaderboard(leaderboard) {
            const leaderboardDiv = document.getElementById('leaderboard');
            
            if (leaderboard.length === 0) {
                leaderboardDiv.innerHTML = '<h3>🏆 Leaderboard</h3><p class="no-scores">No scores yet. Be the first!</p>';
                return;
            }

            let html = '<h3>🏆 Leaderboard</h3><div class="leaderboard-list">';
            
            leaderboard.forEach((entry, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                const timeStr = formatTime(entry.time);
                const date = new Date(entry.date).toLocaleDateString();
                
                html += `
                    <div class="leaderboard-entry ${index < 3 ? 'podium' : ''}">
                        <span class="rank">${medal}</span>
                        <span class="player-info">
                            <strong>${entry.name}</strong>
                            <small>${date}</small>
                        </span>
                        <span class="time">${timeStr}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            leaderboardDiv.innerHTML = html;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toFixed(2).padStart(5, '0')}`;
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Buzz Wire Game 🎮</h1>
        
        <div class="game-layout">
            <!-- Left Panel - Name Input -->
            <div class="left-panel">
                <div class="name-section">
                    <h3>Player Setup</h3>
                    <input type="text" id="nameInput" placeholder="Enter your name" maxlength="20">
                    <button id="setNameBtn">Set Name</button>
                    <div id="playerDisplay"></div>
                </div>
                
                <div class="instructions">
                    <h4>How to Play:</h4>
                    <ul>
                        <li>Enter your name</li>
                        <li>Press <kbd>S</kbd> to start</li>
                        <li>Guide your finger along the white wire</li>
                        <li>Don't touch the wire boundaries!</li>
                        <li>Press <kbd>R</kbd> to restart</li>
                    </ul>
                </div>
            </div>
            
            <!-- Center - Video Feed -->
            <div class="center-panel">
                <div class="video-container">
                    <img src="{{ url_for('video_feed') }}" id="video" alt="Game Video Feed" />
                </div>
                <div id="message" class="message" style="display: none;"></div>
            </div>
            
            <!-- Right Panel - Leaderboard -->
            <div class="right-panel">
                <div id="leaderboard">
                    <h3>🏆 Leaderboard</h3>
                    <p class="loading">Loading...</p>
                </div>
            </div>
        </div>
        
        <footer>
            <p><b>A KAGO PRODUCTION</b></p>
        </footer>
    </div>
</body>
</html>